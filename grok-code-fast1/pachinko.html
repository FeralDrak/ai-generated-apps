<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pachinko Roguelike</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #222;
            color: white;
            margin: 0;
            padding: 20px;
        }
        canvas {
            border: 2px solid #fff;
            background-color: #000;
            display: block;
            margin: 0 auto;
        }
        #ui {
            margin-top: 20px;
        }
        #gameOver {
            display: none;
            background-color: rgba(0,0,0,0.8);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
    </style>
</head>
<body>
<h1>Pachinko Roguelike</h1>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<div id="ui">
    Score: <span id="score">0</span> | Vieux Items: <span id="items">0</span> | Niveau: <span id="level">1</span>
    <br>
    <button onclick="startGame()">Commencer</button>
</div>
<div id="gameOver">
    <h2>Game Over</h2>
    <p>Score Final: <span id="finalScore">0</span></p>
    <button onclick="restartGame()">Recommencer</button>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const ui = document.getElementById('ui');
    const gameOver = document.getElementById('gameOver');

    let score = 0;
    let level = 1;
    let itemsCount = 0;
    let ball = { x: 400, y: 50, vx: 0, vy: 0, radius: 10 };
    let pins = [];
    let coins = [];
    let enemies = [];
    let powerUps = [];
    let gravity = 0.5;
    let gameRunning = false;
    let gameOverFlag = false;

    // Générer un niveau procédural
    function generateLevel() {
        pins = [];
        coins = [];
        enemies = [];
        powerUps = [];
        for (let i = 0; i < 50 + level * 10; i++) {
            pins.push({ x: Math.random() * 800, y: 100 + Math.random() * 500, radius: 5 });
        }
        for (let i = 0; i < 10; i++) {
            coins.push({ x: Math.random() * 800, y: 100 + Math.random() * 500, radius: 8, collected: false });
        }
        for (let i = 0; i < level; i++) {
            enemies.push({ x: Math.random() * 800, y: 100 + Math.random() * 500, radius: 15, active: true });
        }
        for (let i = 0; i < 5; i++) {
            const type = Math.floor(Math.random() * 3); // 0: slow, 1: magnet, 2: multi
            powerUps.push({ x: Math.random() * 800, y: 100 + Math.random() * 500, radius: 10, type });
        }
    }

    // Lancer la bille
    function launchBall() {
        ball.x = Math.max(20, Math.min(780, event.clientX - canvas.offsetLeft));
        ball.y = 50;
        ball.vx = 0;
        ball.vy = 0;
    }

    // Boucle de jeu
    function gameLoop() {
        if (!gameRunning || gameOverFlag) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Dessiner pins
        ctx.fillStyle = '#ccc';
        pins.forEach(pin => {
            ctx.beginPath();
            ctx.arc(pin.x, pin.y, pin.radius, 0, Math.PI * 2);
            ctx.fill();
        });

        // Dessiner pièces
        ctx.fillStyle = '#ffd700';
        coins.forEach(coin => {
            if (!coin.collected) {
                ctx.beginPath();
                ctx.arc(coin.x, coin.y, coin.radius, 0, Math.PI * 2);
                ctx.fill();
            }
        });

        // Dessiner ennemis
        ctx.fillStyle = '#f00';
        enemies.forEach(enemy => {
            if (enemy.active) {
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, enemy.radius, 0, Math.PI * 2);
                ctx.fill();
            }
        });

        // Dessiner power-ups
        ctx.fillStyle = '#0f0';
        powerUps.forEach(pu => {
            ctx.beginPath();
            ctx.arc(pu.x, pu.y, pu.radius, 0, Math.PI * 2);
            ctx.fill();
        });

        // Mettre à jour bille
        ball.vy += gravity;
        ball.x += ball.vx;
        ball.y += ball.vy;

        // Collisions avec pins
        pins.forEach(pin => {
            const dist = Math.sqrt((ball.x - pin.x) ** 2 + (ball.y - pin.y) ** 2);
            if (dist < ball.radius + pin.radius) {
                // Rebond simple
                ball.vy *= -0.8;
                ball.vx += (Math.random() - 0.5) * 2;
            }
        });

        // Collisions avec pièces
        coins.forEach(coin => {
            if (!coin.collected) {
                const dist = Math.sqrt((ball.x - coin.x) ** 2 + (ball.y - coin.y) ** 2);
                if (dist < ball.radius + coin.radius) {
                    coin.collected = true;
                    score += 10;
                    itemsCount++;
                    document.getElementById('score').textContent = score;
                    document.getElementById('items').textContent = itemsCount;
                }
            }
        });

        // Collisions avec ennemis
        enemies.forEach(enemy => {
            if (enemy.active) {
                const dist = Math.sqrt((ball.x - enemy.x) ** 2 + (ball.y - enemy.y) ** 2);
                if (dist < ball.radius + enemy.radius) {
                    enemy.active = false; // Ennemi neutralisé, mais bille redirigée
                    ball.vx *= -1;
                    ball.vy *= -1;
                }
            }
        });

        // Collisions avec power-ups (regrouper pour le joueur)
        // ... (simplifié : juste collecte)
        // Ici, on pourrait ajouter logiques spécifiques, mais pour simplicité, juste score

        // Dessiner bille
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
        ctx.fill();

        // Vérifier victoire
        if (ball.y > 600) {
            // Next level
            level++;
            document.getElementById('level').textContent = level;
            generateLevel();
            ball.y = 50;
            ball.vx = 0;
            ball.vy = 0;
            gravity += 0.1; // Difficulte accrue
        }

        // Vérifier défaite
        if (ball.x < 0 || ball.x > 800) {
            gameOverFlag = true;
            gameOver.style.display = 'flex';
            document.getElementById('finalScore').textContent = score;
            ui.style.display = 'none';
        }

        requestAnimationFrame(gameLoop);
    }

    function startGame() {
        gameRunning = true;
        gameOver.style.display = 'none';
        ui.style.display = 'block';
        score = 0;
        level = 1;
        itemsCount = 0;
        document.getElementById('score').textContent = score;
        document.getElementById('level').textContent = level;
        document.getElementById('items').textContent = itemsCount;
        generateLevel();
        canvas.addEventListener('mousedown', launchBall);
        gameLoop();
    }

    function restartGame() {
        gameOverFlag = false;
        startGame();
    }
</script>
</body>
</html>